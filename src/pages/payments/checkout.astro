---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout>
  <div
    id="redirect-container"
    class="flex flex-col items-center justify-center min-h-screen mx-auto"
  >
    <p class="text-lg mb-4">Redirecting to payment gateway...</p>
    <div class="w-12 h-12 border-t-4 border-blue-500 rounded-full animate-spin">
    </div>
  </div>

  <!-- Status container to show success or error messages -->
  <div id="status-container" class="mt-6 text-center"></div>

  <script>
    let redirectUri = "";
    let error = "";

    // Get the publicToken from the URL query string
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("publicToken");

    async function processCheckout() {
      if (token) {
        try {
          const response = await fetch(
            `https://${window.location.host}/.netlify/functions/checkout`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ publicToken: token }),
            },
          );

          if (!response.ok) {
            let error = await response.text();
            error = error.length > 0 ? JSON.parse(error).error : null;
            error = error ?? `Unknown error ${response.status}`;
            throw new Error(error);
          }

          const result = await response.json();
          redirectUri = result.redirectUri;

          if (!redirectUri) {
            throw new Error("No redirect URI found");
          }

          // Save token to localStorage
          localStorage.setItem("snipcartSessionToken", token);

          // Redirect to payment gateway after a delay
          setTimeout(() => {
            window.location.href = redirectUri;
          }, 2000);
        } catch (err) {
          if (err instanceof Error) {
            error = `Unable to process payment. Error: ${err.message}`;
          } else {
            error = "An unknown error occurred.";
          }
          const statusContainer = document.getElementById("status-container");
          if (statusContainer) {
            statusContainer.innerHTML = `<p class="text-lg text-red-500">${error}</p>`;
          }
        }
      } else {
        error = "Missing payment token. Please try again.";
        const statusContainer = document.getElementById("status-container");
        if (statusContainer) {
          statusContainer.innerHTML = `<p class="text-lg text-red-500">${error}</p>`;
        }
      }
    }

    // Run the checkout process
    processCheckout();
  </script>
</BaseLayout>
